# W601设备接入指南

## 概述

本文档说明W601开发板如何接入智慧办公楼系统。

## 系统架构

```
W601开发板 <---> MQTT服务器 <---> 后端服务 <---> 前端界面
    |                |                |              |
  传感器           消息代理         业务处理       数据展示
```

## 通信协议

### 协议类型
- **传输协议**: MQTT v3.1.1
- **数据格式**: JSON
- **QoS级别**: 1 (至少一次)

### MQTT连接参数

```
Broker地址: tcp://your-server-ip:1883
Client ID: W601_001 (设备唯一标识)
Username: (可选)
Password: (可选)
Keep Alive: 60秒
Clean Session: true
```

## 主题定义

### 1. 传感器数据上报

**主题**: `office/sensor/data`
**方向**: W601 → 服务器
**频率**: 每30秒上报一次
**QoS**: 1

**消息格式**:
```json
{
  "deviceId": "W601_001",
  "light": 280.5,
  "temperature": 25.5,
  "humidity": 55.0,
  "flame": false,
  "rgbStatus": true,
  "timestamp": 1697520000000
}
```

**字段说明**:

| 字段 | 类型 | 说明 | 单位 | 示例 |
|------|------|------|------|------|
| deviceId | string | 设备唯一标识 | - | "W601_001" |
| light | number | 光照强度 | lux | 280.5 |
| temperature | number | 温度 | ℃ | 25.5 |
| humidity | number | 湿度 | % | 55.0 |
| flame | boolean | 火焰检测 | - | false |
| rgbStatus | boolean | RGB灯状态 | - | true |
| timestamp | number | 时间戳 | ms | 1697520000000 |

### 2. 设备控制命令

**主题**: `office/control/cmd`
**方向**: 服务器 → W601
**触发**: 自动控制或手动操作
**QoS**: 1

**消息格式**:
```json
{
  "deviceId": "W601_001",
  "action": "rgb_on",
  "params": {
    "brightness": 80
  }
}
```

**支持的控制动作**:

| action | 说明 | 参数 | 设备响应 |
|--------|------|------|----------|
| rgb_on | 开启RGB灯 | brightness (可选) | 点亮RGB灯 |
| rgb_off | 关闭RGB灯 | - | 熄灭RGB灯 |
| buzzer_on | 开启蜂鸣器 | - | 蜂鸣器报警 |
| buzzer_off | 关闭蜂鸣器 | - | 停止蜂鸣器 |
| set_threshold | 设置阈值 | type, value | 更新本地阈值 |

### 3. 告警消息上报

**主题**: `office/alarm`
**方向**: W601 → 服务器
**触发**: 检测到异常情况
**QoS**: 1

**消息格式**:
```json
{
  "deviceId": "W601_001",
  "alarmType": "FIRE",
  "level": "CRITICAL",
  "message": "检测到火焰！",
  "timestamp": 1697520000000
}
```

**告警类型**:

| alarmType | level | 说明 | 触发条件 |
|-----------|-------|------|----------|
| FIRE | CRITICAL | 火灾告警 | 火焰传感器检测到火焰 |
| TEMP | WARNING | 温度异常 | 温度超出阈值 |
| HUMIDITY | WARNING | 湿度异常 | 湿度超出阈值 |
| LIGHT | INFO | 光照异常 | 光照超出阈值 |

## 自动控制逻辑

W601设备需要响应以下自动控制逻辑：

### 1. 智慧照明

```
if (light < 300 && !rgbStatus) {
    // 光照过低且灯是关闭的
    // 服务器发送: {"deviceId":"W601_001", "action":"rgb_on"}
    // 设备响应: 开启RGB灯
}

if (light > 350 && rgbStatus) {
    // 光照充足且灯是开启的
    // 服务器发送: {"deviceId":"W601_001", "action":"rgb_off"}
    // 设备响应: 关闭RGB灯
}
```

### 2. 智慧环境

温度和湿度控制由软件模拟，W601只需上报数据即可。

### 3. 智慧消防

```
if (flame == true) {
    // 检测到火焰
    // 1. W601立即触发蜂鸣器（本地响应）
    // 2. 上报告警消息到 office/alarm 主题
    // 3. 服务器可能发送控制命令确保蜂鸣器开启
}
```

## 设备开发步骤

### 1. 硬件准备

**必需的传感器/执行器**:
- 光照传感器（集成在W601）
- 温湿度传感器（集成在W601）
- 火焰传感器（外接）
- RGB LED灯（集成在W601）
- 蜂鸣器（集成在W601）

### 2. 软件开发

**开发流程**:

```c
// 1. 初始化MQTT客户端
mqtt_init("tcp://server-ip:1883", "W601_001");

// 2. 订阅控制命令主题
mqtt_subscribe("office/control/cmd", 1);

// 3. 设置消息回调
mqtt_set_callback(on_message_callback);

// 4. 定时上报数据（每30秒）
void report_sensor_data() {
    float light = read_light_sensor();
    float temp = read_temperature();
    float humidity = read_humidity();
    bool flame = read_flame_sensor();

    char payload[256];
    sprintf(payload, "{\"deviceId\":\"W601_001\",\"light\":%.2f,\"temperature\":%.2f,\"humidity\":%.2f,\"flame\":%s,\"rgbStatus\":%s,\"timestamp\":%lld}",
            light, temp, humidity,
            flame ? "true" : "false",
            rgb_is_on() ? "true" : "false",
            get_timestamp_ms());

    mqtt_publish("office/sensor/data", payload, 1);
}

// 5. 处理控制命令
void on_message_callback(const char* topic, const char* payload) {
    if (strcmp(topic, "office/control/cmd") == 0) {
        // 解析JSON
        if (contains(payload, "\"action\":\"rgb_on\"")) {
            set_rgb_on();
        } else if (contains(payload, "\"action\":\"rgb_off\"")) {
            set_rgb_off();
        }
        // ... 其他控制命令
    }
}
```

### 3. 测试验证

**测试步骤**:

1. **连接测试**
   - 启动MQTT服务器
   - W601连接到服务器
   - 查看服务器日志确认连接成功

2. **数据上报测试**
   - W601每30秒发送一次数据
   - 使用MQTTX工具订阅 `office/sensor/data` 主题
   - 验证收到的JSON格式是否正确

3. **控制命令测试**
   - 使用MQTTX工具发送控制命令到 `office/control/cmd`
   - 观察W601的RGB灯和蜂鸣器是否响应

4. **自动控制测试**
   - 遮挡光照传感器 → RGB灯应自动开启
   - 移开遮挡物 → RGB灯应自动关闭
   - 触发火焰传感器 → 蜂鸣器应立即响应

## 常见问题

### 1. MQTT连接失败

**可能原因**:
- 服务器地址或端口错误
- 网络不通
- 防火墙阻止

**解决方法**:
```bash
# 测试网络连通性
ping server-ip

# 测试MQTT端口
telnet server-ip 1883
```

### 2. 消息无法发送

**检查项**:
- QoS级别是否设置为1
- Payload格式是否为标准JSON
- 是否已成功连接到MQTT服务器

### 3. 收不到控制命令

**检查项**:
- 是否订阅了 `office/control/cmd` 主题
- deviceId是否匹配
- 回调函数是否正确注册

### 4. RGB灯不响应

**调试方法**:
```c
// 添加日志输出
void on_message_callback(const char* topic, const char* payload) {
    printf("收到消息: %s\n", payload);
    // ... 后续处理
}
```

## 参考代码

完整的模拟器代码参考: `device-simulator/device_simulator.py`

这个Python代码展示了完整的通信流程，可作为W601开发的参考。

## 技术支持

如有问题，请参考：
- MQTT协议文档: https://mqtt.org/
- EMQ X文档: https://www.emqx.io/docs/
- 项目README: `README.md`
