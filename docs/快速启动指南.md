# 快速启动指南

本指南帮助你在5分钟内启动整个智慧办公楼系统。

## 前置条件

确保你的电脑上已安装：

- ✅ Docker & Docker Compose
- ✅ JDK 1.8+
- ✅ Maven 3.6+
- ✅ Python 3.6+
- ✅ Git（可选）

## 启动步骤

### 第一步：启动基础设施（MQTT、MySQL、Redis）

```bash
cd docker
docker-compose up -d
```

等待约30秒，检查服务状态：
```bash
docker-compose ps
```

应该看到3个服务都是 `Up` 状态。

**验证**:
- MQTT管理界面：http://localhost:18083 (admin/public)
- MySQL：localhost:3306 (root/root123)
- Redis：localhost:6379 (redis123)

### 第二步：启动后端服务

**方式1：使用Maven运行（推荐用于开发）**

```bash
# 在新终端窗口中运行
cd backend/device-service
mvn clean spring-boot:run
```

等待看到 `设备管理服务启动成功！`

**验证**:
```bash
curl http://localhost:8081/device/health
```

应该返回：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": "Device Service is running"
}
```

**方式2：打包后运行（推荐用于测试）**

```bash
cd backend/device-service
mvn clean package
java -jar target/device-service-1.0.0.jar
```

### 第三步：启动虚拟设备模拟器

**在新终端窗口中运行**:

```bash
cd device-simulator

# 安装依赖
pip install -r requirements.txt

# 启动模拟器
python device_simulator.py
```

你应该看到：
```
============================================================
W601虚拟设备模拟器
设备ID: W601_001
MQTT服务器: localhost:1883
============================================================

[2024-01-01 10:00:00] ✅ 成功连接到MQTT服务器
[2024-01-01 10:00:00] 📡 已订阅控制命令主题
[2024-01-01 10:00:00] 🚀 模拟器已启动，每30秒上报一次数据
```

## 功能验证

### 1. 查看设备列表

```bash
curl http://localhost:8081/device/list
```

### 2. 获取最新传感器数据

```bash
curl http://localhost:8081/device/W601_001/latest
```

### 3. 手动控制设备

**开灯**:
```bash
curl -X POST http://localhost:8081/device/control \
  -H "Content-Type: application/json" \
  -d '{"deviceId":"W601_001","action":"rgb_on"}'
```

**关灯**:
```bash
curl -X POST http://localhost:8081/device/control \
  -H "Content-Type: application/json" \
  -d '{"deviceId":"W601_001","action":"rgb_off"}'
```

观察虚拟设备模拟器的输出，应该看到控制命令的响应。

### 4. 测试自动控制逻辑

自动控制逻辑会根据光照值自动开关灯：

- 当光照 < 300 lux 时，系统自动发送开灯命令
- 当光照 > 350 lux 时，系统自动发送关灯命令

等待模拟器上报几次数据，观察日志。

### 5. 测试火灾告警

修改 `device-simulator/device_simulator.py` 文件：

```python
self.flame_detected = False  # 改为 True
```

重启模拟器，会立即触发火灾告警。

查看后端日志，应该看到：
```
检测到火焰，已触发蜂鸣器！deviceId=W601_001
```

查询告警记录：
```bash
curl http://localhost:8081/alarm/list
```

## 查看实时数据

### 使用MQTTX工具

1. 下载MQTTX：https://mqttx.app/
2. 创建连接：
   - Name: Smart Office
   - Host: localhost
   - Port: 1883
3. 订阅主题：`office/sensor/data`
4. 观察实时数据

### 使用EMQ X管理界面

1. 访问：http://localhost:18083
2. 登录：admin / public
3. 进入 "WebSocket" 工具
4. 订阅 `office/sensor/data` 主题

## 系统架构验证

现在你的系统应该是这样的：

```
[虚拟设备模拟器]
     ↓ (MQTT: office/sensor/data)
[EMQ X MQTT服务器]
     ↓
[设备管理服务]
     ↓
[MySQL数据库] + [Redis缓存]
```

## 常见问题

### 1. Docker服务启动失败

```bash
# 查看日志
docker-compose logs -f

# 检查端口占用
netstat -ano | findstr :1883
netstat -ano | findstr :3306
netstat -ano | findstr :6379
```

### 2. 后端服务无法连接数据库

检查配置文件 `backend/device-service/src/main/resources/application.yml`：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/smart_office
    username: root
    password: 123456  # 确保密码正确
```

### 3. MQTT连接失败

```bash
# 测试MQTT服务器
docker exec -it smart-office-emqx emqx_ctl status
```

### 4. 模拟器无法连接

检查 `device_simulator.py` 中的配置：
```python
broker="localhost"  # 如果是远程服务器，修改为服务器IP
port=1883
```

## 停止服务

### 停止所有服务

```bash
# 停止后端（Ctrl+C）
# 停止模拟器（Ctrl+C）

# 停止Docker服务
cd docker
docker-compose down
```

### 停止并删除数据

```bash
cd docker
docker-compose down -v
```

## 下一步

- 📖 阅读 [API文档](docs/API.md)
- 🔧 阅读 [W601接入指南](docs/W601接入指南.md)
- 🎨 开发前端界面（Vue）
- 🚀 部署到生产环境

## 开发建议

### 1. 开发后端时

使用IDE（IntelliJ IDEA / Eclipse）打开 `backend` 目录，配置好Maven后可以直接运行 `DeviceServiceApplication`。

### 2. 调试MQTT消息

使用MQTTX工具可以：
- 订阅主题查看消息
- 手动发送测试消息
- 验证消息格式

### 3. 数据库管理

推荐工具：
- Navicat
- DBeaver
- MySQL Workbench

连接信息：
- Host: localhost
- Port: 3306
- Username: root
- Password: 123456
- Database: smart_office

### 4. 查看Redis缓存

```bash
# 进入Redis容器
docker exec -it smart-office-redis redis-cli -a redis123

# 查看所有key
KEYS *

# 查看某个key的值
GET sensor:latest:W601_001
```

## 性能测试

### 模拟多个设备

修改 `device_simulator.py`，创建多个实例：

```python
# 启动3个模拟器
python device_simulator.py &  # W601_001
# 修改device_id后再运行
python device_simulator.py &  # W601_002
python device_simulator.py &  # W601_003
```

### 压力测试

使用 Apache JMeter 或 wrk 对API接口进行压力测试。

## 技术支持

遇到问题？
1. 查看日志文件
2. 检查配置文件
3. 参考各模块的README文档
4. 查看项目根目录的 README.md
