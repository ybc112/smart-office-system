# W601硬件端开发指南

## 概述

本指南详细介绍如何在W601开发板上实现智慧办公楼系统的硬件端功能，包括开发环境搭建、代码实现、硬件连接和测试验证。

## 开发环境要求

### 1. 硬件要求
- **W601开发板** 1块
- **温湿度传感器** DHT22 1个
- **光照传感器** 光敏电阻或光照传感器模块 1个
- **火焰传感器** 火焰检测模块 1个
- **RGB LED灯** 共阴极RGB LED 1个
- **蜂鸣器** 有源蜂鸣器 1个
- **电阻** 220Ω × 3个（RGB限流电阻）
- **面包板和杜邦线** 若干

### 2. 软件要求
- **Arduino IDE** 1.8.0 或更高版本
- **W600 Arduino开发包** 
- **必需的库文件**：
  - WiFi库（内置）
  - PubSubClient库（MQTT客户端）
  - ArduinoJson库（JSON处理）
  - DHT库（温湿度传感器）

## 环境搭建步骤

### 第一步：安装Arduino IDE
1. 从 [Arduino官网](https://www.arduino.cc/en/Main/Software) 下载最新版本的Arduino IDE
2. 安装并启动Arduino IDE

### 第二步：添加W600开发板支持
1. 打开Arduino IDE，进入 **文件 → 首选项**
2. 在"附加开发板管理器网址"中添加：
   ```
   http://arduino.w600.fun/package_w600_index.json
   ```
3. 进入 **工具 → 开发板 → 开发板管理器**
4. 搜索"w600"，选择最新版本并安装

### 第三步：安装必需库文件
在Arduino IDE中，进入 **工具 → 管理库**，搜索并安装以下库：

```
PubSubClient by Nick O'Leary
ArduinoJson by Benoit Blanchon
DHT sensor library by Adafruit
```

## 硬件连接图

### 引脚连接表

| 传感器/设备 | W601引脚 | 说明 |
|------------|----------|------|
| DHT22 温湿度传感器 | D2 | 数据引脚 |
| 光照传感器 | A0 | 模拟输入 |
| 火焰传感器 | D3 | 数字输入 |
| RGB LED - 红 | D9 | PWM输出 |
| RGB LED - 绿 | D10 | PWM输出 |
| RGB LED - 蓝 | D11 | PWM输出 |
| 蜂鸣器 | D8 | 数字输出 |
| VCC | 3.3V | 电源正极 |
| GND | GND | 电源负极 |

### 连接示意图

```
W601开发板
    ┌─────────────────┐
    │  D2  ←→ DHT22   │
    │  A0  ←→ 光照传感器 │
    │  D3  ←→ 火焰传感器 │
    │  D8  ←→ 蜂鸣器    │
    │  D9  ←→ RGB-R   │
    │  D10 ←→ RGB-G   │
    │  D11 ←→ RGB-B   │
    │ 3.3V ←→ VCC     │
    │ GND  ←→ GND     │
    └─────────────────┘
```

## 代码配置

### 1. 修改WiFi配置
在 `W601_SmartOffice.ino` 文件中修改以下参数：

```cpp
// WiFi配置
const char* WIFI_SSID = "your_wifi_ssid";        // 替换为你的WiFi名称
const char* WIFI_PASSWORD = "your_wifi_password"; // 替换为你的WiFi密码
```

### 2. 修改MQTT服务器配置
```cpp
// MQTT配置
const char* MQTT_SERVER = "192.168.1.100";  // 替换为你的服务器IP地址
const int MQTT_PORT = 1883;
const char* DEVICE_ID = "W601_001";          // 可以修改设备ID
```

### 3. 硬件引脚配置（如需要）
如果你的硬件连接与默认配置不同，可以修改引脚定义：

```cpp
#define DHT_PIN 2           // 温湿度传感器引脚
#define LIGHT_SENSOR_PIN A0 // 光照传感器引脚
#define FLAME_SENSOR_PIN 3  // 火焰传感器引脚
// ... 其他引脚定义
```

## 编译和上传

### 1. 选择开发板
- 进入 **工具 → 开发板**
- 选择 **TB-01** 或对应的W601开发板型号

### 2. 配置参数
- **端口**：选择正确的COM端口
- **Upload Speed**：建议选择 115200 或 2Mbps
- **Upload Files**：选择 IMG

### 3. 编译上传
1. 点击 **验证** 按钮检查代码是否有错误
2. 点击 **上传** 按钮将代码烧录到开发板

## 功能测试

### 1. 串口监视器测试
1. 上传代码后，打开 **工具 → 串口监视器**
2. 设置波特率为 **115200**
3. 观察输出信息，确认：
   - WiFi连接成功
   - MQTT连接成功
   - 传感器数据正常读取

### 2. 数据上报测试
观察串口输出，每30秒应该看到类似以下的传感器数据：
```
=== 传感器数据 ===
温度: 25.30°C
湿度: 55.20%
光照: 456.00 lux
火焰: 正常
传感器数据发送成功:
{"deviceId":"W601_001","light":456,"temperature":25.3,"humidity":55.2,"flame":false,"rgbStatus":false,"timestamp":123456}
```

### 3. 控制命令测试
可以通过以下方式测试设备控制：
1. 使用前端界面发送控制命令
2. 使用MQTTX工具手动发送命令到 `office/control/cmd` 主题

测试命令示例：
```json
{"deviceId":"W601_001","action":"rgb_on"}
{"deviceId":"W601_001","action":"rgb_off"}
{"deviceId":"W601_001","action":"buzzer_on"}
{"deviceId":"W601_001","action":"buzzer_off"}
```

### 4. 火焰告警测试
1. 手动触发火焰传感器（用打火机靠近，注意安全）
2. 观察蜂鸣器是否立即响起
3. 检查串口输出是否有告警消息
4. 确认前端界面是否收到告警

## 自动控制逻辑

系统实现了以下自动控制功能：

### 1. 智慧照明
- **触发条件**：光照强度 < 300 lux
- **控制动作**：自动开启RGB灯
- **恢复条件**：光照强度 > 350 lux，自动关闭RGB灯

### 2. 智慧消防
- **触发条件**：火焰传感器检测到火焰
- **控制动作**：
  1. 硬件端立即开启蜂鸣器（本地响应）
  2. 发送告警消息到服务器
  3. 服务器可能发送额外控制命令

## 故障排查

### 1. WiFi连接失败
**现象**：串口显示"WiFi连接失败"
**解决方法**：
- 检查WiFi名称和密码是否正确
- 确认WiFi信号强度足够
- 尝试重启开发板

### 2. MQTT连接失败
**现象**：串口显示"MQTT连接失败"
**解决方法**：
- 检查MQTT服务器IP地址是否正确
- 确认MQTT服务器是否正常运行
- 检查网络连通性：`ping server-ip`

### 3. 传感器读取异常
**现象**：温湿度显示为NaN或异常值
**解决方法**：
- 检查传感器连接是否正确
- 确认传感器供电是否正常
- 尝试更换传感器

### 4. 设备控制无响应
**现象**：发送控制命令后设备无反应
**解决方法**：
- 检查MQTT连接是否正常
- 确认设备ID是否匹配
- 查看串口输出是否收到控制命令

## 扩展功能

### 1. 添加新传感器
要添加新的传感器，需要：
1. 在硬件引脚定义中添加新引脚
2. 在 `readSensors()` 函数中添加读取逻辑
3. 在 `publishSensorData()` 函数中添加到JSON数据

### 2. 添加新的控制设备
要添加新的控制设备，需要：
1. 定义新的控制引脚
2. 在 `handleControlCommand()` 函数中添加新的action处理
3. 实现对应的控制函数

### 3. 自定义告警逻辑
可以在 `loop()` 函数中添加自定义的告警检测逻辑，参考 `checkFlameAlarm()` 函数的实现。

## 性能优化建议

1. **降低功耗**：
   - 使用深度睡眠模式
   - 合理设置数据上报频率

2. **提高稳定性**：
   - 添加看门狗定时器
   - 实现网络断线重连机制

3. **增强安全性**：
   - 使用MQTT用户名密码认证
   - 实现数据加密传输

## 技术支持

如遇到问题，可以参考：
- [W600 Arduino官方文档](http://w600.fun/development/arduino/start/)
- [项目完整文档](../docs/)
- [设备模拟器代码](../device-simulator/)

## 版本历史

- **v1.0** (2024-01-01)
  - 初始版本
  - 实现基础的传感器数据采集和设备控制功能
  - 支持WiFi和MQTT通信
  - 实现火焰告警功能