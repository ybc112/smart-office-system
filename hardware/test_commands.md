# W601硬件端测试验证指南

## 测试环境准备

### 1. 硬件连接检查
确保所有传感器和设备按照以下方式正确连接：

```
W601开发板连接图：
┌─────────────────────────────────────┐
│  W601开发板                          │
├─────────────────────────────────────┤
│  D2  ←→ DHT22 (温湿度传感器)         │
│  A0  ←→ 光照传感器                   │
│  D3  ←→ 火焰传感器                   │
│  D8  ←→ 蜂鸣器                       │
│  D9  ←→ RGB LED (红)                │
│  D10 ←→ RGB LED (绿)                │
│  D11 ←→ RGB LED (蓝)                │
│ 3.3V ←→ 传感器VCC                   │
│ GND  ←→ 传感器GND                   │
└─────────────────────────────────────┘
```

### 2. 软件环境检查
- Arduino IDE 已安装并配置W600开发板支持
- 必需库文件已安装：PubSubClient, ArduinoJson, DHT sensor library
- MQTT服务器正常运行（默认端口1883）
- 后端服务正常运行

## 测试步骤

### 第一步：基础功能测试

#### 1.1 编译和上传代码
```bash
# 在Arduino IDE中：
1. 打开 W601_SmartOffice.ino
2. 修改WiFi配置：WIFI_SSID 和 WIFI_PASSWORD
3. 修改MQTT服务器地址：MQTT_SERVER
4. 选择正确的开发板和端口
5. 点击"验证"检查编译
6. 点击"上传"烧录到设备
```

#### 1.2 串口监视器检查
打开串口监视器（波特率115200），应该看到以下启动信息：

```
=== W601智慧办公楼系统启动 ===
初始化硬件...
硬件初始化完成
连接WiFi: your_wifi_ssid
..........
WiFi连接成功!
IP地址: 192.168.1.xxx
信号强度: -45 dBm
连接MQTT服务器...连接成功!
订阅主题成功: office/control/cmd
设备状态发送成功: online
=== 设备自检开始 ===
检查传感器...
=== 传感器数据 ===
温度: 25.30°C
湿度: 55.20%
光照: 456.00 lux
火焰: 正常
✅ 温湿度传感器正常
检查RGB灯...
✅ RGB灯测试完成
检查蜂鸣器...
✅ 蜂鸣器测试完成
=== 设备自检完成 ===
=== 系统初始化完成 ===
```

### 第二步：传感器数据测试

#### 2.1 数据上报验证
每30秒应该看到传感器数据上报：

```
=== 传感器数据 ===
温度: 25.30°C
湿度: 55.20%
光照: 456.00 lux
火焰: 正常
传感器数据发送成功:
{"deviceId":"W601_001","light":456.00,"temperature":25.30,"humidity":55.20,"flame":false,"rgbStatus":false,"buzzerStatus":false,"timestamp":123456}
```

#### 2.2 后端数据接收验证
检查后端日志，确认收到传感器数据：

```bash
# 查看device-service日志
cd backend/device-service
mvn spring-boot:run

# 应该看到类似日志：
[INFO] 收到传感器数据: {"deviceId":"W601_001",...}
[INFO] 设备数据保存成功
```

#### 2.3 前端数据显示验证
打开前端界面，检查设备管理页面是否显示最新的传感器数据。

### 第三步：设备控制测试

#### 3.1 RGB灯控制测试
通过前端界面或MQTT工具发送控制命令：

**开启RGB灯：**
```json
主题: office/control/cmd
消息: {"deviceId":"W601_001","action":"rgb_on"}
```

**关闭RGB灯：**
```json
主题: office/control/cmd
消息: {"deviceId":"W601_001","action":"rgb_off"}
```

**预期结果：**
- 串口显示：`收到MQTT消息` 和 `💡 RGB灯已开启/🌑 RGB灯已关闭`
- 硬件上RGB灯相应开启/关闭

#### 3.2 蜂鸣器控制测试
**开启蜂鸣器：**
```json
主题: office/control/cmd
消息: {"deviceId":"W601_001","action":"buzzer_on"}
```

**关闭蜂鸣器：**
```json
主题: office/control/cmd
消息: {"deviceId":"W601_001","action":"buzzer_off"}
```

**预期结果：**
- 串口显示：`🔔 蜂鸣器已开启/🔕 蜂鸣器已关闭`
- 硬件上蜂鸣器相应响起/停止

### 第四步：自动控制测试

#### 4.1 智能照明测试
**测试步骤：**
1. 用手遮挡光照传感器，模拟光照不足
2. 观察串口输出和RGB灯状态
3. 移开遮挡物，恢复正常光照
4. 再次观察设备反应

**预期结果：**
```
💡 光照不足，自动开启照明
自动控制消息发送成功:
{"deviceId":"W601_001","action":"AUTO_LIGHT_ON",...}

🌞 光照充足，自动关闭照明
自动控制消息发送成功:
{"deviceId":"W601_001","action":"AUTO_LIGHT_OFF",...}
```

#### 4.2 火焰告警测试
**⚠️ 安全提示：请在安全环境下进行测试，准备好灭火设备**

**测试步骤：**
1. 用打火机在火焰传感器附近点火（保持安全距离）
2. 观察设备立即反应
3. 熄灭火源，观察告警解除

**预期结果：**
```
🚨 检测到火焰！触发告警
🔔 蜂鸣器已开启
告警消息发送成功:
{"deviceId":"W601_001","alarmType":"FIRE","message":"检测到火焰！立即疏散！",...}

✅ 火焰告警解除
告警消息发送成功:
{"deviceId":"W601_001","alarmType":"FIRE_CLEAR","message":"火焰告警已解除",...}
```

### 第五步：系统稳定性测试

#### 5.1 长时间运行测试
让设备连续运行24小时，观察：
- WiFi连接是否稳定
- MQTT连接是否稳定
- 数据上报是否正常
- 内存使用是否正常

#### 5.2 网络断线恢复测试
1. 断开WiFi连接
2. 观察设备重连行为
3. 恢复网络连接
4. 确认设备自动重连成功

#### 5.3 MQTT服务器重启测试
1. 重启MQTT服务器
2. 观察设备重连行为
3. 确认重连后功能正常

## 测试工具

### 1. MQTTX客户端
下载并安装MQTTX，用于手动发送MQTT消息测试：

```
连接配置：
- Host: localhost (或你的服务器IP)
- Port: 1883
- Client ID: test_client
```

### 2. 串口监视器
使用Arduino IDE内置串口监视器或其他串口工具：
- 波特率：115200
- 数据位：8
- 停止位：1
- 校验位：无

### 3. 网络工具
```bash
# 测试网络连通性
ping 192.168.1.100

# 测试MQTT端口
telnet 192.168.1.100 1883
```

## 常见问题排查

### 1. WiFi连接失败
```
检查项目：
□ WiFi名称和密码是否正确
□ WiFi信号强度是否足够
□ 路由器是否支持2.4GHz频段
□ 设备是否在WiFi覆盖范围内
```

### 2. MQTT连接失败
```
检查项目：
□ MQTT服务器IP地址是否正确
□ MQTT服务器是否正常运行
□ 防火墙是否阻止1883端口
□ 网络连通性是否正常
```

### 3. 传感器读取异常
```
检查项目：
□ 传感器连接是否正确
□ 传感器供电是否正常
□ 引脚定义是否正确
□ 传感器是否损坏
```

### 4. 设备控制无响应
```
检查项目：
□ MQTT连接是否正常
□ 设备ID是否匹配
□ 控制命令格式是否正确
□ 硬件连接是否正常
```

## 性能指标

### 正常运行指标
- **WiFi连接时间**: < 30秒
- **MQTT连接时间**: < 10秒
- **数据上报间隔**: 30秒
- **控制响应时间**: < 1秒
- **火焰告警响应时间**: < 0.5秒
- **内存使用**: < 80%
- **运行稳定性**: > 24小时无重启

### 数据准确性要求
- **温度精度**: ±0.5°C
- **湿度精度**: ±3%RH
- **光照检测**: 0-1000 lux范围
- **火焰检测**: 实时响应，无误报

## 测试报告模板

```
W601硬件端测试报告
==================

测试日期：____年__月__日
测试人员：__________
设备版本：v1.0

基础功能测试：
□ 编译上传成功
□ WiFi连接正常
□ MQTT连接正常
□ 设备自检通过

传感器测试：
□ 温湿度读取正常
□ 光照检测正常
□ 火焰检测正常
□ 数据上报正常

设备控制测试：
□ RGB灯控制正常
□ 蜂鸣器控制正常
□ 控制响应及时

自动控制测试：
□ 智能照明正常
□ 火焰告警正常
□ 自动控制逻辑正确

稳定性测试：
□ 长时间运行稳定
□ 网络断线恢复正常
□ 服务器重启恢复正常

问题记录：
1. ________________
2. ________________
3. ________________

测试结论：
□ 通过  □ 不通过

备注：
_________________________
```

## 下一步优化建议

1. **功耗优化**: 实现深度睡眠模式
2. **安全增强**: 添加MQTT认证和数据加密
3. **功能扩展**: 支持更多传感器类型
4. **用户界面**: 添加本地配置界面
5. **OTA更新**: 支持远程固件更新