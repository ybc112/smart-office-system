# W601虚拟设备模拟器

## 简介
这是一个Python编写的W601开发板模拟器，用于在没有真实硬件的情况下测试智慧办公楼系统。

## 功能特性

- ✅ 模拟传感器数据上报（光照、温湿度、火焰检测）
- ✅ 接收并响应控制命令（RGB灯、蜂鸣器）
- ✅ 自动模拟白天/夜晚的光照变化
- ✅ 可手动触发火灾告警测试
- ✅ 支持MQTT通信协议

## 环境要求

- Python 3.6+
- paho-mqtt库

## 安装依赖

```bash
cd device-simulator
pip install -r requirements.txt
```

## 使用方法

### 1. 启动MQTT服务器
确保MQTT服务器已经启动（参考 `docker/README.md`）

### 2. 运行模拟器
```bash
python device_simulator.py
```

### 3. 修改配置
在 `device_simulator.py` 文件底部可以修改配置：

```python
simulator = W601Simulator(
    device_id="W601_001",  # 设备ID
    broker="localhost",     # MQTT服务器地址
    port=1883              # MQTT服务器端口
)
```

## 模拟场景

### 1. 正常运行
启动后，模拟器每30秒自动发送一次传感器数据：
- 白天（8:00-18:00）：光照 300-800 lux
- 夜晚（其他时间）：光照 50-250 lux
- 温度：25℃ ± 3℃
- 湿度：55% ± 10%

### 2. 自动开关灯测试
系统会根据光照值自动控制RGB灯：
- 光照 < 300 lux → 自动开灯
- 光照 > 350 lux → 自动关灯

观察模拟器输出，会看到控制命令的响应。

### 3. 火灾告警测试
修改代码：
```python
self.flame_detected = False  # 改为 True
```
重新运行模拟器，会触发火焰检测告警。

### 4. 手动控制测试
通过前端或API发送控制命令，模拟器会响应：
- rgb_on / rgb_off
- buzzer_on / buzzer_off

## 输出示例

```
============================================================
W601虚拟设备模拟器
设备ID: W601_001
MQTT服务器: localhost:1883
============================================================

[2024-01-01 10:00:00] ✅ 成功连接到MQTT服务器
[2024-01-01 10:00:00] 📡 已订阅控制命令主题

[2024-01-01 10:00:00] 🚀 模拟器已启动，每30秒上报一次数据

[2024-01-01 10:00:00] 📤 发送传感器数据:
  光照: 456.78 lux
  温度: 26.3 ℃
  湿度: 58.2 %
  火焰: ✅ 正常
  RGB灯: 🌑 关闭

[2024-01-01 10:00:05] 📥 收到控制命令:
  Device ID: W601_001
  Action: rgb_on
[2024-01-01 10:00:05] 💡 RGB灯已开启
```

## 多设备模拟

可以同时启动多个模拟器实例模拟多个设备：

```bash
# 终端1
python device_simulator.py  # 默认 W601_001

# 终端2 - 修改代码中的device_id为W601_002后运行
python device_simulator.py
```

## 与真实W601硬件对接

当真实W601硬件到货后：
1. 使用相同的MQTT主题和消息格式
2. 参考 `docs/W601接入指南.md`
3. 模拟器代码可作为硬件开发参考

## 故障排查

### 1. 无法连接MQTT服务器
- 检查MQTT服务器是否启动：`docker ps | grep emqx`
- 检查broker地址和端口是否正确

### 2. 没有收到控制命令
- 检查订阅的主题是否正确
- 查看MQTT服务器日志

### 3. 后端没有收到数据
- 检查后端服务是否启动
- 查看后端日志
- 使用MQTTX工具验证消息是否发送成功
