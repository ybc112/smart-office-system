# 🏢 智慧办公楼系统 - 完整运行指南

## 📋 项目概述

智慧办公楼系统是基于 **W601 开发板** + **SpringCloud 微服务架构** + **Vue3 前端** 实现的物联网智能管理系统。

### 🎯 核心功能
- **智慧照明**: 光照传感器自动控制RGB灯
- **环境监控**: 温湿度实时监测与自动调控
- **消防安全**: 火焰检测与自动报警
- **设备管理**: 实时状态监控与远程控制
- **数据可视化**: 实时图表与历史数据分析

### 🏗️ 系统架构
```
W601硬件设备 ←→ MQTT服务器 ←→ SpringCloud后端 ←→ Vue3前端
     ↓              ↓              ↓              ↓
   传感器数据      消息代理        业务处理        数据展示
```

---

## 🚀 快速开始

### 方式一：使用真实W601硬件（推荐）
如果你有W601开发板和传感器，可以体验完整的物联网功能。

### 方式二：仅运行软件系统
如果没有硬件，系统仍可正常运行，只是没有真实传感器数据。

---

## 📦 环境准备

### 1. 基础软件环境

#### Java环境
```bash
# 检查Java版本（需要JDK 1.8+）
java -version

# 检查Maven版本（需要3.6+）
mvn -version
```

#### 数据库环境
```bash
# MySQL 8.0
mysql --version

# Redis
redis-server --version
```

#### 前端环境
```bash
# Node.js 16+
node --version
npm --version
```

### 2. MQTT服务器

#### 方式一：使用Docker（推荐）
```bash
cd docker
docker-compose up -d emqx
```

#### 方式二：本地安装Mosquitto
```bash
# Windows
winget install EclipseMosquitto
net start mosquitto

# 检查端口
netstat -an | findstr 1883
```

---

## 🗄️ 数据库初始化

### 1. 创建数据库
```bash
# 连接MySQL
mysql -u root -p

# 执行初始化脚本
mysql -u root -p < database/init.sql
```

### 2. 验证数据库
```sql
-- 检查数据库和表
SHOW DATABASES;
USE smart_office;
SHOW TABLES;

-- 检查初始数据
SELECT * FROM device LIMIT 5;
SELECT * FROM user LIMIT 5;
```

---

## 🔧 后端服务启动

### 方式一：使用JAR文件（推荐）

#### 1. 启动Device Service
```bash
cd backend/device-service/target
java -jar device-service-1.0.0.jar
```

**启动成功标志：**
```
Started DeviceServiceApplication in 15.234 seconds
Tomcat started on port(s): 8081
```

#### 2. 启动User Service（新开终端）
```bash
cd backend/user-service/target
java -jar user-service-1.0.0.jar
```

**启动成功标志：**
```
Started UserServiceApplication in 12.456 seconds
Tomcat started on port(s): 8082
```

### 方式二：使用Maven命令
```bash
# 如果遇到依赖问题，先重新构建
cd backend
mvn clean install -DskipTests

# 启动服务
cd device-service && mvn spring-boot:run
cd user-service && mvn spring-boot:run
```

### 3. 验证后端服务
```bash
# 检查Device Service
curl http://localhost:8081/device/list

# 检查User Service
curl http://localhost:8082/user/info
```

---

## 🎨 前端启动

### 1. 安装依赖
```bash
cd frontend
npm install
```

### 2. 启动开发服务器
```bash
npm run dev
```

### 3. 访问系统
打开浏览器访问：http://localhost:5173

**默认登录账号：**
- 用户名：`admin`
- 密码：`123456`

---

## 🔌 硬件连接（可选）

### 1. 硬件清单
- W601 IoT开发板 × 1
- DHT22温湿度传感器 × 1
- 光敏电阻模块 × 1
- 火焰传感器 × 1
- RGB LED × 1
- 蜂鸣器 × 1
- 杜邦线若干

### 2. 连接方式

#### DHT22温湿度传感器
```
DHT22 → W601
VCC   → 3V3
DATA  → PA1
GND   → GND
```

#### 光敏电阻模块
```
光敏电阻 → W601
VCC      → 3V3
GND      → GND
AO       → PA2 (ADC)
```

#### 火焰传感器
```
火焰传感器 → W601
VCC       → 3V3
GND       → GND
DO        → PA3
```

#### RGB LED
```
RGB LED → W601
VCC     → 3V3
GND     → GND
R       → PA4
G       → PA5
B       → PA6
```

#### 蜂鸣器
```
蜂鸣器 → W601
VCC   → 3V3
GND   → GND
IO    → PA7
```

### 3. 烧录固件

#### 准备固件文件
使用项目中的 `W601_SmartOffice/` 目录下的MicroPython代码。

#### 配置WiFi和MQTT
编辑 `config.py` 文件：
```python
# WiFi配置
WIFI_SSID = "你的WiFi名称"
WIFI_PASSWORD = "你的WiFi密码"

# MQTT配置
MQTT_BROKER = "192.168.1.100"  # 你的服务器IP
MQTT_PORT = 1883
DEVICE_ID = "W601_001"
```

#### 上传代码到W601
1. 连接W601到电脑
2. 使用Thonny IDE或其他MicroPython工具
3. 上传所有Python文件到W601
4. 重启设备

---

## 🔧 系统配置

### 1. MQTT配置

#### 后端配置
编辑 `backend/device-service/src/main/resources/application.yml`：
```yaml
mqtt:
  broker-url: tcp://192.168.1.100:1883  # 修改为你的MQTT服务器地址
  client-id: smart-office-backend
  topics:
    sensor-data: office/sensor/data
    alarm: office/alarm
    control: office/control/cmd
```

#### 前端配置
如果需要修改MQTT配置，可在系统设置页面进行调整。

### 2. 数据库配置
编辑 `backend/device-service/src/main/resources/application.yml`：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/smart_office
    username: root
    password: 你的MySQL密码
```

---

## 🧪 系统测试

### 1. 功能测试

#### 登录测试
1. 访问 http://localhost:5173
2. 使用 admin/123456 登录
3. 检查是否成功进入仪表板

#### 设备数据测试
1. 查看仪表板是否显示设备列表
2. 检查传感器数据是否更新
3. 测试设备控制功能

#### 告警测试
1. 触发火焰传感器（如果有硬件）
2. 检查告警是否正常显示
3. 验证蜂鸣器是否响应

### 2. 接口测试
```bash
# 获取设备列表
curl http://localhost:8081/device/list

# 获取传感器数据
curl http://localhost:8081/device/data/W601_001

# 获取告警记录
curl http://localhost:8081/alarm/list
```

---

## 🐛 常见问题

### 1. 后端启动失败

#### 问题：端口被占用
```bash
# 查看端口占用
netstat -ano | findstr 8081
# 杀死进程
taskkill /PID <进程ID> /F
```

#### 问题：数据库连接失败
- 检查MySQL是否启动
- 验证数据库用户名密码
- 确认数据库已创建

### 2. 前端访问问题

#### 问题：页面无法加载
- 检查Node.js版本是否符合要求
- 清除npm缓存：`npm cache clean --force`
- 重新安装依赖：`rm -rf node_modules && npm install`

#### 问题：接口调用失败
- 检查后端服务是否正常启动
- 验证代理配置是否正确

### 3. 硬件连接问题

#### 问题：设备无法连接WiFi
- 检查WiFi名称和密码是否正确
- 确认WiFi信号强度
- 检查路由器是否支持2.4GHz

#### 问题：MQTT连接失败
- 验证MQTT服务器地址和端口
- 检查防火墙设置
- 确认网络连通性

### 4. 数据不显示问题

#### 问题：前端无数据
1. 检查WebSocket连接状态
2. 验证后端MQTT配置
3. 确认设备是否正常发送数据

#### 问题：传感器数据异常
1. 检查传感器连接是否正确
2. 验证引脚配置
3. 测试传感器是否正常工作

---

## 📊 系统监控

### 1. 服务状态监控
```bash
# 检查Java进程
jps -l

# 检查端口占用
netstat -ano | findstr "8081\|8082\|5173"

# 检查系统资源
tasklist | findstr java
```

### 2. 日志查看
```bash
# 后端日志
tail -f backend/device-service/logs/application.log
tail -f backend/user-service/logs/application.log

# MQTT日志
tail -f docker/emqx/log/emqx.log
```

### 3. 数据库监控
```sql
-- 检查设备数据
SELECT COUNT(*) FROM device_data WHERE DATE(create_time) = CURDATE();

-- 检查告警记录
SELECT COUNT(*) FROM alarm_log WHERE DATE(create_time) = CURDATE();

-- 检查设备状态
SELECT device_id, status, last_heartbeat FROM device;
```

---

## 🔄 系统维护

### 1. 定期备份
```bash
# 数据库备份
mysqldump -u root -p smart_office > backup_$(date +%Y%m%d).sql

# 配置文件备份
cp -r backend/*/src/main/resources/application.yml config_backup/
```

### 2. 日志清理
```bash
# 清理应用日志（保留最近7天）
find backend/*/logs -name "*.log" -mtime +7 -delete

# 清理MQTT日志
find docker/emqx/log -name "*.log" -mtime +7 -delete
```

### 3. 性能优化
- 定期清理历史数据
- 优化数据库索引
- 监控内存使用情况
- 调整JVM参数

---

## 📚 相关文档

- [硬件连接详细指南](hardware/Hardware_Connection_Guide.md)
- [W601接入指南](docs/W601接入指南.md)
- [API接口文档](docs/API.md)
- [MicroPython测试指南](hardware/MicroPython_Test_Guide.md)

---

## 🆘 技术支持

如果遇到问题，请按以下顺序排查：

1. **查看日志**: 检查后端和前端控制台输出
2. **验证配置**: 确认数据库、MQTT等配置正确
3. **网络检查**: 测试各服务间的网络连通性
4. **重启服务**: 按顺序重启各个服务组件
5. **查阅文档**: 参考相关技术文档和FAQ

---

## 📝 更新日志

### v1.0.0 (2024-01-XX)
- ✅ 完成基础系统架构
- ✅ 实现W601硬件接入
- ✅ 完成前后端功能开发
- ✅ 添加完整文档支持

---

**🎉 恭喜！现在你已经成功搭建了完整的智慧办公楼系统！**